---
title: "Test 14: Z-test for Two Correlation Coefficients"
output:
  word_document:
    highlight: "default"
    reference_docx: word_styles.docx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Step_1, warning=FALSE, message=FALSE}
# Load Required Functions:
source(file = "muFunc.R")

# Load Required Packages:
wants <- c("dplyr", "psych", "pacman", "ggplot2",
           "PerformanceAnalytics", "miscor", "cocor")
has <- wants %in% rownames(x = installed.packages())
if(any(!has)) install.packages(wants[!has])
pacman::p_load(char = wants)

# Load Required Data:
data <- read.csv(file = "data/Data_Test_14.csv", header = TRUE)

# Show Data:
headTail(x = data)
```

```{r Step_2, fig.width=4, fig.height=4, dpi=600}
# Assumption Checking:
# 1. The x and y Values Originate from Normal Distributions.

# Mashhad
# Use Shapiro-Wilk Normality Test:
shapiro.test(x = data$Mashhad_T)
shapiro.test(x = data$Mashhad_SSH)

# Normality Plot:
ggqqplot(data = data$Mashhad_T, ylab = "Mashhad Temp. (C)")
ggqqplot(data = data$Mashhad_SSH, ylab = "Mashhad Sunshine (h)")


# Sabzevar
# Use Shapiro-Wilk Normality Test:
shapiro.test(x = data$Sabzevar_T)
shapiro.test(x = data$Sabzevar_SSH)

# Normality Plot:
ggqqplot(data = data$Sabzevar_T, ylab = "Sabzevar Temp. (C)")
ggqqplot(data = data$Sabzevar_SSH, ylab = "Sabzevar Sunshine (h)")

# 2. The Relationships Are Linear.

# Mashhad
# Visualize Data Using Scatter Plots:
ggscatter(data = data, x = "Mashhad_T", y = "Mashhad_SSH", add = "reg.line",
          conf.int = TRUE, xlab = "Temp. (C)", ylab = "Sunshine (h)")

# Sabzavar
# Visualize Data Using Scatter Plots:
ggscatter(data = data, x = "Sabzevar_T", y = "Sabzevar_SSH", add = "reg.line",
          conf.int = TRUE, xlab = "Temp. (C)", ylab = "Sunshine (h)")
```

```{r Step_3}
# Method 1:---------------------------------------------------------------------
# Mashhad
data1 = data %>% select(Year, Mashhad_T, Mashhad_SSH) %>% na.omit()
x1 = data1$Mashhad_T
x1_bar = mean(x = x1)

y1 = data1$Mashhad_SSH
y1_bar = mean(x = y1)

n1 = length(x1)

# Correlation Coefficient (r)
r1 = (sum((x1 - x1_bar) * (y1 - y1_bar))) / (sqrt(sum((x1 - x1_bar) ^ 2) * sum((y1 - y1_bar) ^ 2)))

# Fisher Z-transformation:
Z1 = 0.5 * log((1 + r1) / (1 - r1))

# and standard deviation:
sd_Z1 = 1 / sqrt(n1 - 3)

# Sabzevar
data2 = data %>% select(Year, Sabzevar_T, Sabzevar_SSH) %>% na.omit()
x2 = object = data2$Sabzevar_T
x2_bar = mean(x = x2)

y2 = object = data2$Sabzevar_SSH
y2_bar = mean(x = y2)

n2 = length(x2)

# Correlation Coefficient (r)
r2 = (sum((x2 - x2_bar) * (y2 - y2_bar))) / (sqrt(sum((x2 - x2_bar) ^ 2) * sum((y2 - y2_bar) ^ 2)))

# Fisher Z-transformation:
Z2 = 0.5 * log((1 + r2) / (1 - r2))

# and standard deviation:
sd_Z2 = 1 / sqrt(n2 - 3)

# Test Statistic
Z = (Z1 - Z2) / sqrt((sd_Z1 ^ 2) + (sd_Z2 ^ 2))

# Compute the critical values at 0.05 significance level (two tailed).
alpha = 0.05
z.half.alpha = round(x = qnorm(p = (1 - alpha/2)), digits = 4)

# P-value for Spearman's rank correlation coefficient (Two Tailed).
p_value = 2 âˆ— (1 - pnorm(q = Z))

cat("z-score: ", Z, "\n")
cat("Critical values: ", c(-z.half.alpha, z.half.alpha), "\n")
cat("P-value: ", p_value, "\n")

plotDistStat(dist = "Normal",
             to = 3,
             alpha_level = 0.05,
             statistic_point = Z,
             p_value = p_value)

# Method 2:---------------------------------------------------------------------
# setting initial parameter values:
(m <- cor.test(x = data$Mashhad_T, y = data$Mashhad_SSH, 
              alternative = "two.sided", conf.level = 0.95))

(s <- cor.test(x = data$Sabzevar_T, y = data$Sabzevar_SSH,
              alternative = "two.sided", conf.level = 0.95))

# use "cocor.indep.groups" function from "cocor" package:

cocor.indep.groups(r1.jk = m$estimate, n1 = 40,
                   r2.hm = s$estimate, n2 = 38,
                   alternative = "two.sided")

```

